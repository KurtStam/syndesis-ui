machine:
  pre:
  - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  node:
    version: 6.9.1
  services:
  - docker

general:
  artifacts:
  - dist

dependencies:
  pre:
    - npm install
    - npm update
    - npm prune
  override:
    - npm run build

test:
  override:
  - rm -Rf $CIRCLE_ARTIFACTS/coverage $CIRCLE_TEST_REPORTS/junit
  - mkdir $CIRCLE_ARTIFACTS/coverage
  - mkdir $CIRCLE_TEST_REPORTS/junit
  - npm run test

deployment:
  latest:
    owner: redhat-ipaas
    branch: master
    commands:
    - npm run build:prod
    - docker build -t rhipaas/ipaas-client:latest . | cat -
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - docker push rhipaas/ipaas-client:latest | cat -
  release:
    owner: redhat-ipaas
    tag: /v[0-9]+(\.[0-9]+){2}/
    commands:
    - npm run build:prod
    - docker build -t rhipaas/ipaas-client:latest . | cat -
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - docker push rhipaas/ipaas-client:latest | cat -
